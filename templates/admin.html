<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Cheer Factory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            color: #333;
        }
        .tab-btn.active {
            color: #333;
            border-bottom: 2px solid #333;
            margin-bottom: -2px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .category-content {
            display: none;
        }
        .category-content.active {
            display: block;
        }
        .sub-tab-btn.active {
            background: #333 !important;
            color: white !important;
            border-color: #333 !important;
        }
        .lunch-image-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #f9f9f9;
        }
        .lunch-image-item img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
        }
        .lunch-image-item .image-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .lunch-image-item textarea {
            flex: 1;
            resize: vertical;
            min-height: 60px;
        }
        /* Image Search Grid */
        .image-search-section {
            margin-bottom: 12px;
        }
        .image-search-input {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .image-search-input input {
            flex: 1;
            margin-bottom: 0;
        }
        .translated-query {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .image-grid-item {
            position: relative;
            aspect-ratio: 4/3;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .image-grid-item:hover {
            border-color: #333;
        }
        .image-grid-item.selected {
            border-color: #2e7d32;
        }
        .image-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-grid-item .photographer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .use-image-btn {
            width: 100%;
            margin-top: 8px;
        }
        /* Pagination */
        .image-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 12px 0;
        }
        .image-pagination button {
            padding: 8px 16px;
            font-size: 13px;
        }
        .image-pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .image-pagination .page-info {
            font-size: 13px;
            color: #666;
        }
        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .image-modal.active {
            display: flex;
        }
        .image-modal img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }
        .image-modal .modal-info {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
        }
        .image-modal .modal-info .photographer {
            font-size: 14px;
            margin-bottom: 12px;
        }
        .image-modal .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }
        .image-modal .modal-select {
            padding: 12px 24px;
            background: #2e7d32;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        /* Stats Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .stat-card .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }
        .stat-card .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .recent-posts {
            margin-top: 16px;
        }
        .recent-posts h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #444;
        }
        .recent-post-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .recent-post-item:last-child {
            border-bottom: none;
        }
        .recent-post-item .post-date {
            color: #888;
        }
        .seo-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            font-size: 13px;
        }
        .seo-item .check {
            color: #2e7d32;
            font-weight: bold;
        }
        .seo-item .cross {
            color: #c62828;
            font-weight: bold;
        }
        .ga-configured {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }
        .ga-not-configured {
            background: #fff3e0;
            color: #e65100;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }
        /* Generated Image Preview */
        .generated-image-preview {
            position: relative;
        }
        .generated-image-preview img {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .generated-image-preview img:hover {
            transform: scale(1.02);
        }
        .generated-image-preview .click-hint {
            font-size: 11px;
            color: #888;
            text-align: center;
            margin-top: 4px;
        }
        .cancel-btn {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }
        .cancel-btn:hover {
            background: #eee;
            color: #333;
        }
        /* Naver Queue Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        .status-pending {
            background: #fff3e0;
            color: #e65100;
        }
        .status-processing {
            background: #e3f2fd;
            color: #1565c0;
        }
        .status-published {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status-failed {
            background: #ffebee;
            color: #c62828;
        }
        .naver-queue-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .naver-queue-table {
            width: 100%;
            font-size: 13px;
            border-collapse: collapse;
        }
        .naver-queue-table th {
            padding: 8px;
            text-align: left;
            background: #f5f5f5;
            font-weight: 500;
        }
        .naver-queue-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .naver-queue-table tr:last-child td {
            border-bottom: none;
        }
        .delete-queue-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }
        .delete-queue-btn:hover {
            background: #cc0000;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><a href="/"><img src="https://res.cloudinary.com/df0kpimbc/image/upload/v1769844220/cheer-factory/logo.png" alt="Cheer Factory" style="height: 28px; width: auto;"></a></h1>
            <p class="tagline">Admin Panel</p>
            <div class="admin-nav">
                <a href="/">View Site</a>
                <span class="divider">|</span>
                <a href="/admin/logout">Logout</a>
            </div>
        </header>

        <main>
            <div class="admin-panel">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('write')">Write</button>
                    <button class="tab-btn" onclick="switchTab('prompt')">Prompt</button>
                    <button class="tab-btn" onclick="switchTab('stats')">Stats</button>
                    <button class="tab-btn" onclick="switchTab('naver')">Naver</button>
                </div>

                <!-- Write Tab -->
                <div id="tab-write" class="tab-content active">
                    <!-- Category Sub-tabs -->
                    <div class="sub-tabs" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                        <button class="sub-tab-btn active" onclick="switchCategory('diary')" style="padding: 10px; background: #f5f5f5; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">그림일기</button>
                        <button class="sub-tab-btn" onclick="switchCategory('lunch')" style="padding: 10px; background: #f5f5f5; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">서울명동 로컬, 점심이야기</button>
                    </div>

                    <!-- 그림일기 Category -->
                    <div id="category-diary" class="category-content active">
                        <div class="admin-section">
                            <h2>AI Generate</h2>
                            <div class="input-group" style="flex-direction: column; gap: 10px;">
                                <textarea id="topic" placeholder="Topic (optional)" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                                <button onclick="generatePost()" id="generateBtn" style="align-self: flex-start;">Generate</button>
                            </div>
                        </div>

                    <div class="admin-section">
                        <h2>Image Search (Pexels)</h2>
                        <div class="image-search-section">
                            <div class="image-search-input">
                                <input type="text" id="imageSearchQuery" placeholder="Search images (Korean OK)">
                                <button onclick="searchImages()" id="searchImagesBtn">Search</button>
                            </div>
                            <div id="translatedQuery" class="translated-query"></div>
                            <div id="imageSearchResults" class="image-grid"></div>
                            <div id="imagePagination" class="image-pagination" style="display:none;">
                                <button onclick="loadPage(currentPage - 1)" id="prevPageBtn">Prev</button>
                                <span class="page-info" id="pageInfo"></span>
                                <button onclick="loadPage(currentPage + 1)" id="nextPageBtn">Next</button>
                            </div>
                            <button onclick="useSelectedImage()" id="useImageBtn" class="use-image-btn" style="display:none;">Use This Image</button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h2>Image Upload + Tags</h2>
                        <input type="file" id="imageInput" accept="image/*" onchange="analyzeImage()">
                        <div id="imagePreview" class="image-preview"></div>
                        <div id="tagsResult" class="tags-result"></div>
                        <div id="uploadedUrl" class="uploaded-url"></div>
                        <button onclick="copyTags()" id="copyTagsBtn" style="display:none;">Copy Tags</button>
                    </div>

                    <div class="admin-section">
                        <h2>AI Image Generation</h2>
                        <p style="font-size: 12px; color: #888; margin-bottom: 12px;">
                            포스트 내용을 기반으로 AI가 이미지를 생성합니다. 제목과 내용을 먼저 작성하세요.
                        </p>
                        <button onclick="generateAIImage()" id="generateImageBtn">Generate Image</button>
                        <div id="generatedImagePreview" class="generated-image-preview" style="margin-top: 12px;"></div>
                        <div id="generatedImageActions" style="display: none; margin-top: 8px; display: flex; gap: 8px;">
                            <button onclick="cancelGeneratedImage()" class="cancel-btn" style="flex: 1;">Cancel</button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h2>Write Post</h2>
                        <input type="text" id="title" placeholder="Title">
                        <textarea id="content" placeholder="Content..." rows="8"></textarea>
                        <input type="text" id="tags" placeholder="Tags (comma separated)">

                        <div style="margin-bottom: 12px;">
                            <label style="display: block; font-size: 13px; color: #666; margin-bottom: 8px;">Images (Multiple)</label>
                            <div id="imagesList" style="display: flex; flex-direction: column; gap: 8px;">
                                <!-- 이미지 목록이 여기 표시됩니다 -->
                            </div>
                            <button onclick="addImageField()" type="button" style="width: 100%; margin-top: 8px; background: #f5f5f5; color: #666;">+ Add Image URL</button>
                        </div>

                        <button onclick="publishPost('diary')" id="publishBtn" class="primary">Publish</button>
                    </div>
                    </div>
                    <!-- End 그림일기 Category -->

                    <!-- 점심이야기 Category -->
                    <div id="category-lunch" class="category-content" style="display: none;">
                        <div class="admin-section">
                            <h2>Restaurant Information</h2>
                            <p style="font-size: 12px; color: #888; margin-bottom: 12px;">
                                식당 정보를 입력하세요. 네이버 지도와 방문 횟수가 포함됩니다.
                            </p>
                            <input type="text" id="restaurantName" placeholder="식당 이름 (예: 명동교자)">
                            <input type="text" id="restaurantAddress" placeholder="식당 주소 (예: 서울 중구 명동10길 29)">
                            <button onclick="searchNaverPlace()" id="searchPlaceBtn" style="margin-top: 8px;">Search Naver Place</button>
                            <div id="placeSearchResults" style="margin-top: 12px;"></div>

                            <div style="margin-top: 12px; padding: 12px; background: #f9f9f9; border-radius: 8px; display: none;" id="selectedPlaceInfo">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 500;">선택된 식당:</span>
                                    <span id="selectedPlaceName" style="color: #333;"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 500;">현재 방문 횟수:</span>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <button onclick="decrementVisitCount()" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">-</button>
                                        <input type="number" id="visitCount" value="1" min="1" style="width: 60px; text-align: center; margin: 0;">
                                        <button onclick="incrementVisitCount()" style="padding: 4px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">+</button>
                                    </div>
                                </div>
                                <p style="font-size: 11px; color: #666; margin: 0;">* 이전에 방문한 적이 있다면 방문 횟수를 조정하세요</p>
                            </div>
                        </div>

                        <div class="admin-section">
                            <h2>Upload Images with Descriptions</h2>
                            <p style="font-size: 12px; color: #888; margin-bottom: 12px;">
                                각 이미지에 대한 간단한 설명(1문장)을 작성하세요. 여러 이미지의 설명을 바탕으로 글이 생성됩니다.
                            </p>
                            <input type="file" id="lunchImageInput" accept="image/*" multiple onchange="uploadLunchImages()">
                            <div id="lunchImagesPreview" style="margin-top: 12px;"></div>
                        </div>

                        <div class="admin-section">
                            <h2>Generate Content</h2>
                            <button onclick="generateLunchContent()" id="generateLunchBtn" class="primary">Generate Content from Images</button>
                        </div>

                        <div class="admin-section">
                            <h2>Edit Post</h2>
                            <textarea id="lunchContent" placeholder="Content will be generated..." rows="8"></textarea>
                            <input type="text" id="lunchTags" placeholder="Tags (comma separated)">

                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 8px;">Images</label>
                                <div id="lunchImagesList"></div>
                            </div>
                        </div>

                        <div class="admin-section">
                            <h2>Generate Title</h2>
                            <button onclick="generateLunchTitle()" id="generateTitleBtn">Generate Title from Content</button>
                            <input type="text" id="lunchTitle" placeholder="Title will be generated..." style="margin-top: 12px;">
                        </div>

                        <div class="admin-section">
                            <h2>Generate Thumbnail (Optional)</h2>
                            <p style="font-size: 12px; color: #888; margin-bottom: 12px;">
                                제목을 기반으로 썸네일 이미지를 생성합니다.
                            </p>
                            <button onclick="generateLunchThumbnail()" id="generateThumbnailBtn">Generate Thumbnail</button>
                            <div id="lunchThumbnailPreview" style="margin-top: 12px;"></div>
                            <button onclick="useThumbnailAsFirstImage()" id="useThumbnailBtn" style="display: none; margin-top: 8px;">Use as First Image</button>
                        </div>

                        <div class="admin-section">
                            <button onclick="publishPost('lunch')" id="publishLunchBtn" class="primary">Publish</button>
                        </div>
                    </div>
                    <!-- End 점심이야기 Category -->
                </div>

                <!-- Prompt Tab -->
                <div id="tab-prompt" class="tab-content">
                    <div class="admin-section">
                        <h2>AI Prompt Settings</h2>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                            AI가 글을 생성할 때 사용하는 프롬프트입니다. 카테고리별로 다른 프롬프트를 설정할 수 있습니다.
                        </p>

                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <button onclick="loadPromptType('diary')" id="promptDiaryBtn" class="prompt-type-btn active" style="flex: 1; padding: 8px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer;">그림일기 Prompt</button>
                            <button onclick="loadPromptType('lunch')" id="promptLunchBtn" class="prompt-type-btn" style="flex: 1; padding: 8px; background: #f5f5f5; color: #666; border: none; border-radius: 4px; cursor: pointer;">점심이야기 Prompt</button>
                        </div>

                        <textarea id="promptText" placeholder="Loading..." rows="15"></textarea>
                        <button onclick="savePrompt()" id="savePromptBtn" class="primary">Save Prompt</button>
                    </div>
                </div>

                <!-- Stats Tab -->
                <div id="tab-stats" class="tab-content">
                    <div class="admin-section">
                        <h2>Cache Management</h2>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                            포스트 데이터는 5분간 캐시됩니다. 새 포스트가 보이지 않으면 캐시를 무효화하세요.
                        </p>
                        <button onclick="invalidateCache()" id="invalidateCacheBtn" class="primary">Invalidate Cache</button>
                    </div>

                    <div class="admin-section">
                        <h2>Site Statistics</h2>
                        <div id="statsContent" class="stats-content">
                            <p style="color: #888;">Loading statistics...</p>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h2>Google Analytics</h2>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                            Google Analytics를 설정하면 방문자 통계를 확인할 수 있습니다.
                        </p>
                        <div id="gaStatus" class="ga-status">
                            <p style="color: #888;">Checking GA status...</p>
                        </div>
                        <div style="margin-top: 16px;">
                            <h3 style="font-size: 14px; margin-bottom: 8px;">설정 방법:</h3>
                            <ol style="font-size: 13px; color: #666; padding-left: 20px; line-height: 1.8;">
                                <li><a href="https://analytics.google.com" target="_blank" style="color: #2196F3;">Google Analytics</a> 접속 후 계정 생성</li>
                                <li>속성 추가 > 웹 선택 > URL 입력</li>
                                <li>측정 ID(G-XXXXXXX) 복사</li>
                                <li>Render 환경변수에 <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 4px;">GA_ID=G-XXXXXXX</code> 추가</li>
                                <li>서비스 재배포</li>
                            </ol>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h2>SEO Status</h2>
                        <div id="seoStatus" class="seo-status">
                            <p style="color: #888;">Loading SEO status...</p>
                        </div>
                    </div>
                </div>

                <!-- Naver Tab -->
                <div id="tab-naver" class="tab-content">
                    <div class="admin-section">
                        <h2>Naver Blog Publishing Queue</h2>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                            Cheer Factory 포스트를 네이버 블로그에 발행합니다. 로컬 Worker가 실행 중이어야 합니다.
                        </p>
                        <button onclick="refreshNaverQueue()" id="refreshQueueBtn">Refresh Queue</button>

                        <div id="naverQueueStatus" style="margin-top: 16px;">
                            <p style="color: #888;">Click refresh to load queue status...</p>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h2>Quick Publish to Naver</h2>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                            최근 포스트를 선택하여 네이버 블로그에 발행합니다.
                        </p>
                        <select id="postSelector" style="width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="">Select a post...</option>
                        </select>
                        <select id="naverCategorySelector" style="width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="diary">그림일기</option>
                            <option value="lunch">서울명동 로컬, 점심이야기</option>
                        </select>
                        <button onclick="queueForNaver()" id="queueNaverBtn" class="primary">Queue for Naver</button>
                    </div>

                    <div class="admin-section">
                        <h2>Worker Setup</h2>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                            로컬 PC에서 Worker를 실행하세요:
                        </p>
                        <pre style="background: #f5f5f5; padding: 12px; border-radius: 8px; font-size: 12px; overflow-x: auto;">cd mrt_blog_generator
python -m naver.cheer_factory_worker</pre>
                    </div>
                </div>

                <div id="status" class="status"></div>
            </div>
        </main>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" onclick="closeModal(event)">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <img id="modalImage" src="" alt="Preview">
        <div class="modal-info">
            <div class="photographer" id="modalPhotographer"></div>
            <button class="modal-select" onclick="selectFromModal()">Select This Image</button>
        </div>
    </div>

    <script>
        let generatedTags = [];
        let selectedImage = null;
        let currentPage = 1;
        let currentQuery = '';
        let totalResults = 0;
        let modalImageData = null;
        let selectedImages = []; // 선택된 이미지들 (Pexels에서)
        let postImages = []; // 포스트에 추가될 이미지 배열
        let lunchImages = []; // 점심이야기 이미지 배열 {url, description}
        let lunchThumbnailUrl = null; // 생성된 썸네일
        let currentCategory = 'diary'; // 현재 카테고리
        let selectedRestaurant = null; // 선택된 식당 정보 {id, name, address, naver_place_id, visit_count}
        const MAX_IMAGE_SIZE = 1920;
        const IMAGE_QUALITY = 0.85;
        const PER_PAGE = 12;

        // Category switching
        function switchCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.category-content').forEach(content => content.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById(`category-${category}`).style.display = 'block';
        }

        // 이미지 목록 렌더링
        function renderImagesList() {
            const container = document.getElementById('imagesList');
            if (postImages.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px;">No images added yet</p>';
                return;
            }
            container.innerHTML = postImages.map((url, index) => `
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" value="${url}" onchange="updateImageUrl(${index}, this.value)" style="flex: 1; margin: 0;">
                    <button onclick="removeImage(${index})" type="button" style="padding: 8px 12px; background: #ffebee; color: #c62828; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                </div>
            `).join('');
        }

        // 이미지 URL 필드 추가
        function addImageField(url = '') {
            postImages.push(url);
            renderImagesList();
        }

        // 이미지 URL 업데이트
        function updateImageUrl(index, url) {
            postImages[index] = url;
        }

        // 이미지 제거
        function removeImage(index) {
            postImages.splice(index, 1);
            renderImagesList();
        }

        // 페이지 로드 시 기본 필드 하나 추가
        document.addEventListener('DOMContentLoaded', () => {
            renderImagesList();
        });

        // Image Search functions
        async function searchImages(page = 1) {
            const query = document.getElementById('imageSearchQuery').value;
            const btn = document.getElementById('searchImagesBtn');
            const resultsDiv = document.getElementById('imageSearchResults');
            const translatedDiv = document.getElementById('translatedQuery');
            const paginationDiv = document.getElementById('imagePagination');
            const useBtn = document.getElementById('useImageBtn');
            const status = document.getElementById('status');

            if (!query.trim()) {
                status.textContent = 'Enter a search query';
                status.className = 'status error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Searching...';
            resultsDiv.innerHTML = '';
            if (page === 1) {
                translatedDiv.textContent = '';
                paginationDiv.style.display = 'none';
            }
            useBtn.style.display = 'none';
            selectedImage = null;

            try {
                const res = await fetch('/admin/search-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, page })
                });
                const data = await res.json();

                if (data.error) {
                    status.textContent = 'Error: ' + data.error;
                    status.className = 'status error';
                } else {
                    currentQuery = query;
                    currentPage = page;
                    totalResults = data.total_results || 0;

                    if (data.translated_query) {
                        translatedDiv.textContent = `Translated: "${data.translated_query}"`;
                    }

                    if (data.images && data.images.length > 0) {
                        resultsDiv.innerHTML = data.images.map(img => `
                            <div class="image-grid-item" onclick="toggleImageSelection('${img.regular}', '${img.photographer}', event)">
                                <img src="${img.thumb}" alt="Search result">
                                <div class="photographer">${img.photographer}</div>
                            </div>
                        `).join('');

                        // Show pagination if there are more results
                        const totalPages = Math.ceil(totalResults / PER_PAGE);
                        if (totalPages > 1) {
                            paginationDiv.style.display = 'flex';
                            document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
                            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
                            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
                        } else {
                            paginationDiv.style.display = 'none';
                        }
                    } else {
                        resultsDiv.innerHTML = '<p style="grid-column: span 3; text-align: center; color: #888;">No images found</p>';
                        paginationDiv.style.display = 'none';
                    }
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
            }

            btn.disabled = false;
            btn.textContent = 'Search';
        }

        function loadPage(page) {
            if (page < 1) return;
            document.getElementById('imageSearchQuery').value = currentQuery;
            searchImages(page);
        }

        function previewImage(url, photographer) {
            modalImageData = { url, photographer };
            document.getElementById('modalImage').src = url;
            document.getElementById('modalPhotographer').textContent = `Photo by ${photographer} on Pexels`;
            document.getElementById('imageModal').classList.add('active');
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget && !event.target.classList.contains('modal-close')) return;
            document.getElementById('imageModal').classList.remove('active');
            modalImageData = null;
            // Restore select button visibility for next use
            document.querySelector('.modal-select').style.display = 'block';
        }

        function selectFromModal() {
            if (!modalImageData) return;
            selectedImage = modalImageData;
            document.getElementById('useImageBtn').style.display = 'block';
            closeModal();
            document.getElementById('status').textContent = 'Image selected! Click "Use This Image" to upload.';
            document.getElementById('status').className = 'status success';
        }

        // 이미지 선택 토글 (다중 선택 가능)
        function toggleImageSelection(url, photographer, event) {
            const element = event.currentTarget;
            const index = selectedImages.findIndex(img => img.url === url);

            if (index > -1) {
                // 이미 선택됨 - 선택 해제
                selectedImages.splice(index, 1);
                element.classList.remove('selected');
            } else {
                // 선택 추가
                selectedImages.push({ url, photographer });
                element.classList.add('selected');
            }

            // 버튼 표시/숨김
            const useBtn = document.getElementById('useImageBtn');
            if (selectedImages.length > 0) {
                useBtn.style.display = 'block';
                useBtn.textContent = `Use ${selectedImages.length} Image${selectedImages.length > 1 ? 's' : ''}`;
            } else {
                useBtn.style.display = 'none';
            }
        }

        async function useSelectedImage() {
            if (selectedImages.length === 0) return;

            const btn = document.getElementById('useImageBtn');
            const status = document.getElementById('status');

            btn.disabled = true;
            btn.textContent = `Uploading ${selectedImages.length} image(s)...`;

            try {
                let uploadedCount = 0;
                const photographers = [];

                for (const img of selectedImages) {
                    const res = await fetch('/admin/download-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_url: img.url
                        })
                    });
                    const data = await res.json();

                    if (data.error) {
                        status.textContent = `Error uploading image: ${data.error}`;
                        status.className = 'status error';
                        continue;
                    }

                    // 배열에 추가
                    postImages.push(data.image_url);
                    photographers.push(img.photographer);
                    uploadedCount++;
                }

                if (uploadedCount > 0) {
                    renderImagesList();
                    status.textContent = `${uploadedCount} image(s) uploaded! Photos by ${photographers.join(', ')} on Pexels`;
                    status.className = 'status success';

                    // Clear search
                    document.getElementById('imageSearchResults').innerHTML = '';
                    document.getElementById('translatedQuery').textContent = '';
                    btn.style.display = 'none';
                    selectedImages = [];
                    document.querySelectorAll('.image-grid-item').forEach(el => el.classList.remove('selected'));
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
            }

            btn.disabled = false;
            btn.textContent = 'Use This Image';
        }

        // Allow Enter key to search
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('imageSearchQuery').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchImages();
            });
        });

        // AI Image Generation
        let generatedImageUrl = null;

        async function generateAIImage() {
            const btn = document.getElementById('generateImageBtn');
            const previewDiv = document.getElementById('generatedImagePreview');
            const actionsDiv = document.getElementById('generatedImageActions');
            const status = document.getElementById('status');
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value;

            if (!title && !content) {
                status.textContent = 'Please write title or content first';
                status.className = 'status error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Generating...';
            previewDiv.innerHTML = '<p style="color: #888; text-align: center;">AI is creating your image...</p>';
            actionsDiv.style.display = 'none';

            try {
                const res = await fetch('/admin/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content, tags })
                });
                const data = await res.json();

                if (data.error) {
                    status.textContent = 'Error: ' + data.error;
                    status.className = 'status error';
                    previewDiv.innerHTML = '';
                } else {
                    generatedImageUrl = data.image_url;
                    previewDiv.innerHTML = `
                        <img src="${data.image_url}" alt="Generated Image" onclick="previewGeneratedImage('${data.image_url}')">
                        <p class="click-hint">Click image to view larger</p>
                    `;
                    // 배열에 추가
                    postImages.push(data.image_url);
                    renderImagesList();
                    actionsDiv.style.display = 'flex';
                    status.textContent = 'Image generated and added to images list! Click to preview or Cancel to remove.';
                    status.className = 'status success';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
                previewDiv.innerHTML = '';
            }

            btn.disabled = false;
            btn.textContent = 'Generate Image';
        }

        function previewGeneratedImage(url) {
            document.getElementById('modalImage').src = url;
            document.getElementById('modalPhotographer').textContent = 'AI Generated Image';
            document.getElementById('imageModal').classList.add('active');
            // Hide select button for AI generated images (already applied)
            document.querySelector('.modal-select').style.display = 'none';
        }

        function cancelGeneratedImage() {
            const previewDiv = document.getElementById('generatedImagePreview');
            const actionsDiv = document.getElementById('generatedImageActions');
            const status = document.getElementById('status');

            previewDiv.innerHTML = '';
            actionsDiv.style.display = 'none';

            // 배열에서 마지막 생성된 이미지 제거
            if (generatedImageUrl && postImages.includes(generatedImageUrl)) {
                const index = postImages.indexOf(generatedImageUrl);
                postImages.splice(index, 1);
                renderImagesList();
            }
            generatedImageUrl = null;

            status.textContent = 'Generated image removed.';
            status.className = 'status';
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load prompt when switching to prompt tab
            if (tabName === 'prompt') {
                loadPrompt();
            }
            // Load stats when switching to stats tab
            if (tabName === 'stats') {
                loadStats();
            }
            // Load naver tab data
            if (tabName === 'naver') {
                loadNaverTab();
            }
        }

        // Naver Publishing functions
        async function loadNaverTab() {
            await Promise.all([
                loadPostSelector(),
                refreshNaverQueue()
            ]);
        }

        async function loadPostSelector() {
            const selector = document.getElementById('postSelector');

            try {
                const res = await fetch('/admin/stats');
                const data = await res.json();

                if (data.recent_posts && data.recent_posts.length > 0) {
                    selector.innerHTML = '<option value="">Select a post...</option>' +
                        data.recent_posts.map(p =>
                            `<option value="${p.id}">${p.title.substring(0, 40)}${p.title.length > 40 ? '...' : ''} (${p.date})</option>`
                        ).join('');
                }
            } catch (e) {
                console.error('Failed to load posts:', e);
            }
        }

        async function refreshNaverQueue() {
            const btn = document.getElementById('refreshQueueBtn');
            const statusDiv = document.getElementById('naverQueueStatus');

            btn.disabled = true;
            btn.textContent = 'Loading...';

            try {
                const res = await fetch('/admin/naver-status');
                const data = await res.json();

                if (data.error) {
                    statusDiv.innerHTML = `<p class="error">Error: ${data.error}</p>`;
                } else if (data.queue && data.queue.length > 0) {
                    statusDiv.innerHTML = `
                        <div class="naver-queue-container">
                            <table class="naver-queue-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th style="text-align: center;">Status</th>
                                        <th>Result</th>
                                        <th style="text-align: center; width: 60px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.queue.map(item => `
                                        <tr>
                                            <td>${item.title.substring(0, 30)}${item.title.length > 30 ? '...' : ''}</td>
                                            <td style="text-align: center;">
                                                <span class="status-badge status-${item.status}">${item.status}</span>
                                            </td>
                                            <td>
                                                ${item.naver_url ? `<a href="${item.naver_url}" target="_blank" style="color: #2196F3;">View</a>` :
                                                  item.error_message ? `<span style="color: #c62828;" title="${item.error_message}">${item.error_message.substring(0, 20)}...</span>` : '-'}
                                            </td>
                                            <td style="text-align: center;">
                                                ${['pending', 'processing', 'failed'].includes(item.status) ?
                                                  `<button onclick="deleteQueueItem(${item.id})" class="delete-queue-btn" title="Delete">×</button>` : '-'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = '<p style="color: #888;">No items in queue</p>';
                }
            } catch (e) {
                statusDiv.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }

            btn.disabled = false;
            btn.textContent = 'Refresh Queue';
        }

        async function deleteQueueItem(queueId) {
            if (!confirm('이 항목을 삭제하시겠습니까?')) {
                return;
            }

            try {
                const res = await fetch(`/admin/naver-queue/delete/${queueId}`, {
                    method: 'POST'
                });
                const data = await res.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    refreshNaverQueue();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function queueForNaver() {
            const selector = document.getElementById('postSelector');
            const btn = document.getElementById('queueNaverBtn');
            const status = document.getElementById('status');

            const postId = selector.value;

            if (!postId) {
                status.textContent = 'Please select a post';
                status.className = 'status error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Queuing...';

            try {
                const res = await fetch('/admin/naver-publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ post_id: postId, category: document.getElementById('naverCategorySelector').value })
                });
                const data = await res.json();

                if (data.error) {
                    status.textContent = 'Error: ' + data.error;
                    status.className = 'status error';
                } else {
                    status.textContent = 'Post queued for Naver publishing!';
                    status.className = 'status success';
                    selector.value = '';
                    refreshNaverQueue();
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
            }

            btn.disabled = false;
            btn.textContent = 'Queue for Naver';
        }

        // Stats functions
        async function loadStats() {
            const statsContent = document.getElementById('statsContent');
            const gaStatus = document.getElementById('gaStatus');
            const seoStatus = document.getElementById('seoStatus');

            try {
                const res = await fetch('/admin/stats');
                const data = await res.json();

                if (data.error) {
                    statsContent.innerHTML = `<p class="error">Error: ${data.error}</p>`;
                    return;
                }

                // Render stats
                statsContent.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.total_posts}</div>
                            <div class="stat-label">Total Posts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.posts_ko}</div>
                            <div class="stat-label">Korean Posts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.posts_en}</div>
                            <div class="stat-label">English Posts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.posts_with_images}</div>
                            <div class="stat-label">Posts with Images</div>
                        </div>
                    </div>
                    <div class="recent-posts">
                        <h3>Recent Posts (KO)</h3>
                        ${data.recent_posts.map(p => `
                            <div class="recent-post-item">
                                <span class="post-title">${p.title.substring(0, 30)}${p.title.length > 30 ? '...' : ''}</span>
                                <span class="post-date">${p.date}</span>
                            </div>
                        `).join('')}
                    </div>
                `;

                // GA Status
                if (data.ga_configured) {
                    gaStatus.innerHTML = `
                        <div class="ga-configured">
                            <strong>Google Analytics Configured</strong><br>
                            ID: ${data.ga_id}<br><br>
                            <a href="https://analytics.google.com" target="_blank" style="color: #1b5e20;">
                                Open Google Analytics Dashboard
                            </a>
                        </div>
                    `;
                } else {
                    gaStatus.innerHTML = `
                        <div class="ga-not-configured">
                            <strong>Google Analytics Not Configured</strong><br>
                            환경변수 GA_ID를 설정해주세요.
                        </div>
                    `;
                }

                // SEO Status
                seoStatus.innerHTML = `
                    <div class="seo-item">
                        <span class="check">✓</span> Meta tags configured
                    </div>
                    <div class="seo-item">
                        <span class="check">✓</span> Open Graph tags configured
                    </div>
                    <div class="seo-item">
                        <span class="check">✓</span> <a href="/sitemap.xml" target="_blank" style="color: #2196F3;">sitemap.xml</a> available
                    </div>
                    <div class="seo-item">
                        <span class="check">✓</span> <a href="/robots.txt" target="_blank" style="color: #2196F3;">robots.txt</a> available
                    </div>
                    <div class="seo-item">
                        ${data.ga_configured ? '<span class="check">✓</span>' : '<span class="cross">✗</span>'} Google Analytics
                    </div>
                `;
            } catch (e) {
                statsContent.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }
        }

        // Cache invalidation
        async function invalidateCache() {
            const btn = document.getElementById('invalidateCacheBtn');
            const status = document.getElementById('status');

            btn.disabled = true;
            btn.textContent = 'Invalidating...';
            status.textContent = '';

            try {
                const res = await fetch('/admin/invalidate-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.error) {
                    status.textContent = 'Error: ' + data.error;
                    status.className = 'status error';
                } else {
                    status.textContent = 'Cache invalidated successfully! Refreshing stats...';
                    status.className = 'status success';
                    // Reload stats to reflect changes
                    setTimeout(() => {
                        loadStats();
                    }, 1000);
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
            }

            btn.disabled = false;
            btn.textContent = 'Invalidate Cache';
        }

        // Prompt functions
        let currentPromptType = 'diary';

        async function loadPrompt() {
            await loadPromptType('diary');
        }

        async function loadPromptType(type) {
            currentPromptType = type;
            const textarea = document.getElementById('promptText');
            textarea.value = 'Loading...';

            // Update button styles
            document.querySelectorAll('.prompt-type-btn').forEach(btn => {
                btn.style.background = '#f5f5f5';
                btn.style.color = '#666';
            });
            const btn = type === 'diary' ? document.getElementById('promptDiaryBtn') : document.getElementById('promptLunchBtn');
            btn.style.background = '#333';
            btn.style.color = 'white';

            try {
                const res = await fetch(`/admin/prompt?type=${type}`);
                const data = await res.json();
                if (data.error) {
                    textarea.value = 'Error: ' + data.error;
                } else {
                    textarea.value = data.prompt || '';
                }
            } catch (e) {
                textarea.value = 'Error: ' + e.message;
            }
        }

        async function savePrompt() {
            const prompt = document.getElementById('promptText').value;
            const btn = document.getElementById('savePromptBtn');
            const status = document.getElementById('status');

            if (!prompt.trim()) {
                status.textContent = 'Prompt cannot be empty';
                status.className = 'status error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Saving...';
            status.textContent = '';

            try {
                const res = await fetch('/admin/prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        type: currentPromptType
                    })
                });
                const data = await res.json();

                if (data.error) {
                    status.textContent = 'Error: ' + data.error;
                    status.className = 'status error';
                } else {
                    status.textContent = `Prompt saved for ${currentPromptType === 'diary' ? '그림일기' : '점심이야기'}!`;
                    status.className = 'status success';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
            }

            btn.disabled = false;
            btn.textContent = 'Save Prompt';
        }

        // Image resize
        function resizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width <= MAX_IMAGE_SIZE && height <= MAX_IMAGE_SIZE) {
                            resolve(file);
                            return;
                        }

                        if (width > height) {
                            if (width > MAX_IMAGE_SIZE) {
                                height = Math.round(height * MAX_IMAGE_SIZE / width);
                                width = MAX_IMAGE_SIZE;
                            }
                        } else {
                            if (height > MAX_IMAGE_SIZE) {
                                width = Math.round(width * MAX_IMAGE_SIZE / height);
                                height = MAX_IMAGE_SIZE;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            const resizedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            resolve(resizedFile);
                        }, 'image/jpeg', IMAGE_QUALITY);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function analyzeImage() {
            const input = document.getElementById('imageInput');
            const preview = document.getElementById('imagePreview');
            const tagsResult = document.getElementById('tagsResult');
            const copyBtn = document.getElementById('copyTagsBtn');
            const status = document.getElementById('status');

            if (!input.files || !input.files[0]) return;

            let file = input.files[0];

            const reader = new FileReader();
            reader.onload = (e) => {
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);

            tagsResult.innerHTML = '<p>Resizing & Uploading...</p>';
            status.textContent = '';
            const uploadedUrl = document.getElementById('uploadedUrl');
            uploadedUrl.innerHTML = '';

            file = await resizeImage(file);
            tagsResult.innerHTML = '<p>Analyzing...</p>';

            const formData = new FormData();
            formData.append('image', file);

            try {
                const res = await fetch('/admin/analyze-image', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.error) {
                    tagsResult.innerHTML = `<p class="error">Error: ${data.error}</p>`;
                } else {
                    generatedTags = data.tags || [];
                    const tagsHtml = generatedTags.map(t => `<span class="tag">${t}</span>`).join('');
                    tagsResult.innerHTML = `
                        <p class="description">${data.description || ''}</p>
                        <div class="tags-list">${tagsHtml}</div>
                    `;
                    copyBtn.style.display = 'block';
                    document.getElementById('tags').value = generatedTags.join(',');

                    if (data.image_url) {
                        // 배열에 추가
                        postImages.push(data.image_url);
                        renderImagesList();
                        uploadedUrl.innerHTML = `<p class="success">Image uploaded to Cloudinary and added to images list!</p>`;
                    }
                }
            } catch (e) {
                tagsResult.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }
        }

        function copyTags() {
            const tagsText = generatedTags.join(',');
            navigator.clipboard.writeText(tagsText).then(() => {
                const btn = document.getElementById('copyTagsBtn');
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = 'Copy Tags'; }, 2000);
            });
        }

        async function generatePost() {
            const topic = document.getElementById('topic').value;
            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('status');

            btn.disabled = true;
            btn.textContent = 'Generating...';
            status.textContent = '';

            try {
                const res = await fetch('/admin/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });
                const data = await res.json();

                if (data.error) {
                    status.textContent = 'Error: ' + data.error;
                    status.className = 'status error';
                } else {
                    document.getElementById('title').value = data.title;
                    document.getElementById('content').value = data.content;
                    status.textContent = 'Generated! Edit and publish.';
                    status.className = 'status success';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
            }

            btn.disabled = false;
            btn.textContent = 'Generate';
        }

        // ===== Restaurant Functions =====
        async function searchNaverPlace() {
            const name = document.getElementById('restaurantName').value.trim();
            const address = document.getElementById('restaurantAddress').value.trim();
            const btn = document.getElementById('searchPlaceBtn');
            const resultsDiv = document.getElementById('placeSearchResults');
            const status = document.getElementById('status');

            if (!name) {
                status.textContent = '식당 이름을 입력하세요';
                status.className = 'status error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Searching...';
            resultsDiv.innerHTML = '<p style="color: #888;">Searching Naver Places...</p>';
            status.textContent = '';

            try {
                const res = await fetch('/admin/search-naver-place', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, address })
                });
                const data = await res.json();

                if (data.error) {
                    resultsDiv.innerHTML = `<p class="error">Error: ${data.error}</p>`;
                } else if (data.places && data.places.length > 0) {
                    resultsDiv.innerHTML = `
                        <div style="font-size: 13px; color: #666; margin-bottom: 8px;">검색 결과 (${data.places.length}개):</div>
                        ${data.places.map((place, index) => `
                            <div onclick="selectPlace(${index}, ${JSON.stringify(place).replace(/"/g, '&quot;')})" style="padding: 10px; margin-bottom: 8px; background: #fff; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">
                                <div style="font-weight: 500; margin-bottom: 4px;">${place.name}</div>
                                <div style="font-size: 12px; color: #666;">${place.address}</div>
                                ${place.category ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">${place.category}</div>` : ''}
                            </div>
                        `).join('')}
                    `;
                } else {
                    resultsDiv.innerHTML = '<p style="color: #888;">검색 결과가 없습니다. 식당 이름이나 주소를 확인하세요.</p>';
                }
            } catch (e) {
                resultsDiv.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }

            btn.disabled = false;
            btn.textContent = 'Search Naver Place';
        }

        function selectPlace(index, place) {
            selectedRestaurant = place;

            // UI 업데이트
            document.getElementById('selectedPlaceInfo').style.display = 'block';
            document.getElementById('selectedPlaceName').textContent = place.name;

            // 기존 방문 횟수 로드 또는 1로 설정
            if (place.visit_count > 0) {
                document.getElementById('visitCount').value = place.visit_count + 1;
            } else {
                document.getElementById('visitCount').value = 1;
            }

            // 검색 결과 숨기기
            document.getElementById('placeSearchResults').innerHTML = '<p style="color: #4CAF50;">✓ 식당이 선택되었습니다</p>';

            const status = document.getElementById('status');
            status.textContent = `${place.name} 선택됨. 방문 횟수: ${document.getElementById('visitCount').value}회`;
            status.className = 'status success';
        }

        function incrementVisitCount() {
            const input = document.getElementById('visitCount');
            input.value = parseInt(input.value) + 1;
        }

        function decrementVisitCount() {
            const input = document.getElementById('visitCount');
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
            }
        }

        // ===== 점심이야기 Functions =====
        async function uploadLunchImages() {
            const input = document.getElementById('lunchImageInput');
            const preview = document.getElementById('lunchImagesPreview');
            const status = document.getElementById('status');

            if (!input.files || input.files.length === 0) return;

            preview.innerHTML = '<p>Uploading and resizing images...</p>';
            status.textContent = 'Uploading images...';
            status.className = 'status';

            try {
                for (let file of input.files) {
                    // Resize
                    file = await resizeImage(file);

                    // Upload to analyze-image endpoint
                    const formData = new FormData();
                    formData.append('image', file);

                    const res = await fetch('/admin/analyze-image', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();

                    if (data.error) {
                        status.textContent = `Error: ${data.error}`;
                        status.className = 'status error';
                        continue;
                    }

                    lunchImages.push({
                        url: data.image_url,
                        description: ''
                    });
                }

                renderLunchImagesPreview();
                status.textContent = `${lunchImages.length} image(s) uploaded!`;
                status.className = 'status success';
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
            }
        }

        function renderLunchImagesPreview() {
            const preview = document.getElementById('lunchImagesPreview');
            const imagesList = document.getElementById('lunchImagesList');

            if (lunchImages.length === 0) {
                preview.innerHTML = '<p style="color: #888;">No images uploaded yet</p>';
                imagesList.innerHTML = '<p style="color: #888; font-size: 13px;">No images</p>';
                return;
            }

            preview.innerHTML = lunchImages.map((img, index) => `
                <div class="lunch-image-item">
                    <img src="${img.url}" alt="Image ${index + 1}">
                    <div class="image-info">
                        <label style="font-size: 13px; font-weight: 500;">Image ${index + 1} Description:</label>
                        <textarea placeholder="이 이미지에 대한 간단한 설명 (1문장)..." onchange="updateLunchImageDescription(${index}, this.value)">${img.description}</textarea>
                        <button onclick="removeLunchImage(${index})" type="button" style="align-self: flex-start; padding: 6px 12px; background: #ffebee; color: #c62828; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>
                </div>
            `).join('');

            imagesList.innerHTML = lunchImages.map((img, index) => `
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                    <img src="${img.url}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                    <span style="flex: 1; font-size: 13px; color: #666;">Image ${index + 1}</span>
                </div>
            `).join('');
        }

        function updateLunchImageDescription(index, description) {
            lunchImages[index].description = description;
        }

        function removeLunchImage(index) {
            lunchImages.splice(index, 1);
            renderLunchImagesPreview();
        }

        async function generateLunchContent() {
            const btn = document.getElementById('generateLunchBtn');
            const status = document.getElementById('status');
            const contentArea = document.getElementById('lunchContent');

            if (lunchImages.length === 0) {
                status.textContent = 'Please upload images first';
                status.className = 'status error';
                return;
            }

            // Check if all images have descriptions
            const missingDescriptions = lunchImages.filter(img => !img.description.trim());
            if (missingDescriptions.length > 0) {
                status.textContent = 'Please add descriptions to all images';
                status.className = 'status error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Generating...';
            status.textContent = 'Generating content...';
            status.className = 'status';

            try {
                const res = await fetch('/admin/generate-lunch-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: lunchImages
                    })
                });
                const data = await res.json();

                if (data.error) {
                    status.textContent = 'Error: ' + data.error;
                    status.className = 'status error';
                } else {
                    contentArea.value = data.content;
                    status.textContent = 'Content generated! Now generate a title.';
                    status.className = 'status success';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
            }

            btn.disabled = false;
            btn.textContent = 'Generate Content from Images';
        }

        async function generateLunchTitle() {
            const btn = document.getElementById('generateTitleBtn');
            const status = document.getElementById('status');
            const content = document.getElementById('lunchContent').value;
            const titleInput = document.getElementById('lunchTitle');

            if (!content.trim()) {
                status.textContent = 'Please generate content first';
                status.className = 'status error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Generating...';
            status.textContent = 'Generating title...';
            status.className = 'status';

            try {
                const res = await fetch('/admin/generate-lunch-title', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        images: lunchImages
                    })
                });
                const data = await res.json();

                if (data.error) {
                    status.textContent = 'Error: ' + data.error;
                    status.className = 'status error';
                } else {
                    titleInput.value = data.title;
                    status.textContent = 'Title generated! Optionally generate a thumbnail.';
                    status.className = 'status success';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
            }

            btn.disabled = false;
            btn.textContent = 'Generate Title from Content';
        }

        async function generateLunchThumbnail() {
            const btn = document.getElementById('generateThumbnailBtn');
            const status = document.getElementById('status');
            const title = document.getElementById('lunchTitle').value;
            const preview = document.getElementById('lunchThumbnailPreview');
            const useBtn = document.getElementById('useThumbnailBtn');

            if (!title.trim()) {
                status.textContent = 'Please generate title first';
                status.className = 'status error';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Generating...';
            status.textContent = 'Generating thumbnail...';
            status.className = 'status';
            preview.innerHTML = '<p style="color: #888;">AI is creating thumbnail...</p>';

            try {
                const res = await fetch('/admin/generate-lunch-thumbnail', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                const data = await res.json();

                if (data.error) {
                    status.textContent = 'Error: ' + data.error;
                    status.className = 'status error';
                    preview.innerHTML = '';
                } else {
                    lunchThumbnailUrl = data.image_url;
                    preview.innerHTML = `<img src="${data.image_url}" style="max-width: 300px; border-radius: 8px;">`;
                    useBtn.style.display = 'block';
                    status.textContent = 'Thumbnail generated! Click "Use as First Image" to add it.';
                    status.className = 'status success';
                }
            } catch (e) {
                status.textContent = 'Error: ' + e.message;
                status.className = 'status error';
                preview.innerHTML = '';
            }

            btn.disabled = false;
            btn.textContent = 'Generate Thumbnail';
        }

        function useThumbnailAsFirstImage() {
            if (!lunchThumbnailUrl) return;

            // 썸네일을 맨 앞에 추가
            lunchImages.unshift({
                url: lunchThumbnailUrl,
                description: 'Thumbnail'
            });

            renderLunchImagesPreview();
            document.getElementById('status').textContent = 'Thumbnail added as first image!';
            document.getElementById('status').className = 'status success';
            document.getElementById('useThumbnailBtn').style.display = 'none';
        }

        // ===== End 점심이야기 Functions =====

        async function publishPost(category) {
            if (category === 'diary') {
                // 그림일기 발행
                const title = document.getElementById('title').value;
                const content = document.getElementById('content').value;
                const tags = document.getElementById('tags').value;
                const btn = document.getElementById('publishBtn');
                const status = document.getElementById('status');

                if (!title || !content) {
                    status.textContent = 'Title and content required';
                    status.className = 'status error';
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'Publishing...';
                status.textContent = '';

                try {
                    const res = await fetch('/admin/publish', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title_ko: title,
                            content_ko: content,
                            tags: tags,
                            images: postImages
                        })
                    });
                    const data = await res.json();

                    if (data.error) {
                        status.textContent = 'Error: ' + data.error;
                        status.className = 'status error';
                    } else {
                        status.textContent = 'Published! Auto-deploy will start.';
                        status.className = 'status success';
                        document.getElementById('title').value = '';
                        document.getElementById('content').value = '';
                        document.getElementById('topic').value = '';
                        document.getElementById('tags').value = '';
                        document.getElementById('imagePreview').innerHTML = '';
                        document.getElementById('tagsResult').innerHTML = '';
                        document.getElementById('copyTagsBtn').style.display = 'none';
                        postImages = [];
                        renderImagesList();
                    }
                } catch (e) {
                    status.textContent = 'Error: ' + e.message;
                    status.className = 'status error';
                }

                btn.disabled = false;
                btn.textContent = 'Publish';
            } else if (category === 'lunch') {
                // 점심이야기 발행
                const title = document.getElementById('lunchTitle').value;
                const content = document.getElementById('lunchContent').value;
                const tags = document.getElementById('lunchTags').value;
                const btn = document.getElementById('publishLunchBtn');
                const status = document.getElementById('status');

                if (!title || !content) {
                    status.textContent = 'Title and content required';
                    status.className = 'status error';
                    return;
                }

                if (lunchImages.length === 0) {
                    status.textContent = 'At least one image required';
                    status.className = 'status error';
                    return;
                }

                if (!selectedRestaurant) {
                    status.textContent = 'Please select a restaurant from Naver Place search';
                    status.className = 'status error';
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'Publishing...';
                status.textContent = '';

                try {
                    const imageUrls = lunchImages.map(img => img.url);
                    const visitCount = parseInt(document.getElementById('visitCount').value) || 1;

                    const res = await fetch('/admin/publish', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title_ko: title,
                            content_ko: content,
                            tags: tags,
                            images: imageUrls,
                            category: 'lunch',
                            restaurant: {
                                name: selectedRestaurant.name,
                                address: selectedRestaurant.address,
                                naver_place_id: selectedRestaurant.id,
                                visit_count: visitCount
                            }
                        })
                    });
                    const data = await res.json();

                    if (data.error) {
                        status.textContent = 'Error: ' + data.error;
                        status.className = 'status error';
                    } else {
                        status.textContent = 'Published! Auto-deploy will start.';
                        status.className = 'status success';
                        document.getElementById('lunchTitle').value = '';
                        document.getElementById('lunchContent').value = '';
                        document.getElementById('lunchTags').value = '';
                        document.getElementById('lunchImagesPreview').innerHTML = '';
                        document.getElementById('lunchThumbnailPreview').innerHTML = '';
                        document.getElementById('restaurantName').value = '';
                        document.getElementById('restaurantAddress').value = '';
                        document.getElementById('placeSearchResults').innerHTML = '';
                        document.getElementById('selectedPlaceInfo').style.display = 'none';
                        lunchImages = [];
                        lunchThumbnailUrl = null;
                        selectedRestaurant = null;
                        renderLunchImagesPreview();
                    }
                } catch (e) {
                    status.textContent = 'Error: ' + e.message;
                    status.className = 'status error';
                }

                btn.disabled = false;
                btn.textContent = 'Publish';
            }
        }
    </script>
</body>
</html>
